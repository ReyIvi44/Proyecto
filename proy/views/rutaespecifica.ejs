<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= ruta.features[0].properties["Nombre"] %></title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <h1 class="titulorutas"><%= ruta.features[0].properties["Nombre"] %></h1>
    <p><strong>Parque Nacional:</strong> <%= ruta.features[0].properties["Parque Nacional"] %></p>
    <p><strong>Dificultad:</strong> <%= ruta.features[0].properties.Dificultad %></p>
    <p><strong>Duración:</strong> <%= ruta.features[0].properties["Duración (h)"] %> horas</p>
    <div class="imagenes">
        <!-- Imagen 1 -->
        <img src="/images/rutas/<%= ruta.name%>1.jpg" alt="Imagen 1 de <%= ruta.features[0].properties["Nombre"] %>" class="img-fluid">

        <!-- Imagen 2 -->
        <img src="/images/rutas/<%= ruta.name%>2.jpg" alt="Imagen 2 de <%= ruta.features[0].properties["Nombre"] %>" class="img-fluid">
    </div>
    <p><strong>Descripción:</strong> <%= ruta.features[0].properties.Descripción %></p>
    <p><strong>Recomendaciones:</strong> <%= ruta.features[0].properties.Recomendaciones %></p>


    <div id="mapaRuta" style="height: 500px; margin-top: 20px;"></div>
    <div id="comentarios">
        <h3>Comentarios</h3>
      
        <form id="comentarioForm">
          <input type="text" id="nombre" placeholder="Tu nombre" required>
          <textarea id="mensaje" placeholder="Escribe tu comentario..." required></textarea>
          <button type="submit">Enviar</button>
        </form>
      
        <div id="listaComentarios"></div>
      </div>
    <script>
    // Espera a que la página cargue
    document.addEventListener("DOMContentLoaded", function () {
        const mapa = L.map("mapaRuta").setView([40.4, -3.7], 10); // Coordenadas genéricas

        // Capa base
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        }).addTo(mapa);

        // Obtener datos de la ruta desde el backend
        const ruta = <%- JSON.stringify(ruta) %>;

        // Mostrar cada geometría en el mapa
        ruta.features.forEach(feature => {
        const geojson = L.geoJSON(feature, {
            style: function(feature) {
            // Obtener la dificultad de la ruta
            const dificultad = feature.properties.Dificultad;
            let color;

            // Asignar colores según la dificultad
            switch(dificultad) {
                case "Baja":
                    color = "#00FF00"; // Verde
                    break;
                case "Media":
                    color = "#FFA500"; // Naranja
                    break;
                case "Alta":
                    color = "#FF0000"; // Rojo
                    break;
            }

            return {
                color: color,
                weight: 3,
                opacity: 1
            };
          },
        }).addTo(mapa);

        // Ajustar la vista a la ruta
        mapa.fitBounds(geojson.getBounds());
        });
    });
    </script>
    <script>
        const rutaId = '<%= ruta._id %>'; // Asegúrate de pasar 'ruta' desde el backend
      
        async function cargarComentarios() {
          const res = await fetch(`/comentarios/${rutaId}`);
          const comentarios = await res.json();
      
          const lista = document.getElementById('listaComentarios');
          lista.innerHTML = comentarios.map(c => `
            <div class="comentario">
              <strong>${c.nombre}</strong> <em>${new Date(c.fecha).toLocaleString()}</em>
              <p>${c.mensaje}</p>
            </div>
          `).join('');
        }
      
        document.getElementById('comentarioForm').addEventListener('submit', async e => {
          e.preventDefault();
          const nombre = document.getElementById('nombre').value;
          const mensaje = document.getElementById('mensaje').value;
      
          const res = await fetch('/comentarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rutaId, nombre, mensaje })
          });
      
          if (res.ok) {
            document.getElementById('comentarioForm').reset();
            cargarComentarios();
          }
        });
      
        cargarComentarios();
    </script>

    <a href="/">Volver al mapa</a>

    <footer>
        <p>© 2025 Información de Rutas</p>
    </footer>
</body>
</html>